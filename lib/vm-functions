#!/bin/sh -u
# shellcheck disable=SC2039

#############################################################################
##
##  vm-functions
##
##  Copyright 2021-2022 Dermot Bradley <dermot_bradley@yahoo.com>
##
##  Licensed via GPL version 2.0
##
#############################################################################


#
# Create VM Hyper-V mkinitfs feature file
#
configure_mkinitfs_feature_vm_hyperv() {
  # vm-hyperv.modules

  cat <<'EOF' >> "$run_script"

  {
    write_log "Setting up features.d/vm-hyperv.modules" 2
EOF

  initramfs_entry_initialise "vm-hyperv"
  initramfs_entry_add "kernel/drivers/acpi/tiny-power-button.ko*"
  if [ -n "${image_optimise+x}" ]; then
    initramfs_entry_add "kernel/drivers/hv/hv_balloon.ko*"
    initramfs_entry_add "kernel/drivers/hv/hv_utils.ko*"
    initramfs_entry_add "kernel/drivers/hv/hv_vmbus.ko*"
    initramfs_entry_add "kernel/drivers/net/hyperv/hv_netvsc.ko*"
  else
    initramfs_entry_add "kernel/drivers/hv"
    initramfs_entry_add "kernel/drivers/net/hyperv"
  fi
  initramfs_entry_add "kernel/drivers/scsi/sd_mod.ko*"
  initramfs_entry_add "kernel/drivers/scsi/hv_storvsc.ko*"
  case $image_alpine_release in
    v3.13 | v3.14 )
      initramfs_entry_add "kernel/drivers/video/fbdev/hyperv_fb.ko*" ;;
    * )
      initramfs_entry_add "kernel/drivers/gpu/drm/hyperv/hyperv_drm.ko*" ;;
  esac
  initramfs_entry_finish

  if [ -n "${debug_enabled+x}" ]; then
    cat <<'EOF' >> "$run_script"

    # Debug
    {
      write_debug_log "vm-hyperv.modules contents:" 2
      cat /etc/mkinitfs/features.d/vm-hyperv.modules >> /chroot.log
    }
EOF
  fi

  cat <<'EOF' >> "$run_script"
  }
EOF
}


#
# Create VM QEMU mkinitfs feature file
#
configure_mkinitfs_feature_vm_qemu() {
  # vm-qemu.modules

  cat <<'EOF' >> "$run_script"

  {
    write_log "Setting up features.d/vm-qemu.modules" 2
EOF

  initramfs_entry_initialise "vm-qemu"
  initramfs_entry_add "kernel/drivers/acpi/tiny-power-button.ko*"
  initramfs_entry_add "kernel/drivers/gpu/drm/bochs/bochs-drm.ko*"
  initramfs_entry_add "kernel/drivers/gpu/drm/virtio"

  if [ -n "${image_optimise+x}" ]; then
    ###initramfs_entry_add "kernel/drivers/virtio/virtio_pci.ko*"
    :
  else
    initramfs_entry_add "kernel/drivers/block/virtio_blk.ko*"
  fi
  initramfs_entry_add "kernel/drivers/char/hw_random/rng-core.ko*"
  initramfs_entry_add "kernel/drivers/char/hw_random/virtio-rng.ko*"
  initramfs_entry_add "kernel/drivers/char/virtio_console.ko*"
  initramfs_entry_add "kernel/drivers/crypto/virtio"
  case $image_os_device_type in
    nvme )
      initramfs_entry_add "kernel/drivers/nvme/host/nvme.ko*"
      ;;
    sata | scsi )
      initramfs_entry_add "kernel/drivers/scsi/sd_mod.ko*"
      initramfs_entry_add "kernel/drivers/scsi/virtio_scsi.ko*"
      ;;
  esac
  initramfs_entry_add "kernel/drivers/virtio"
  initramfs_entry_finish

  if [ -n "${debug_enabled+x}" ]; then
    cat <<'EOF' >> "$run_script"

    # Debug
    {
      write_debug_log "vm-qemu.modules contents:" 2
      cat /etc/mkinitfs/features.d/vm-qemu.modules >> /chroot.log
    }
EOF
  fi

  cat <<'EOF' >> "$run_script"
  }
EOF
}


#
# Create VM Virtio mkinitfs feature file
#
configure_mkinitfs_feature_vm_virtio() {
  # vm-virtio.modules

  cat <<'EOF' >> "$run_script"

  {
    write_log "Setting up features.d/vm-virtio.modules" 2
EOF

  initramfs_entry_initialise "vm-virtio"
  initramfs_entry_add "kernel/drivers/acpi/tiny-power-button.ko*"
  initramfs_entry_add "kernel/drivers/gpu/drm/bochs/bochs-drm.ko*"
  initramfs_entry_add "kernel/drivers/gpu/drm/virtio"

  if [ -n "${image_optimise+x}" ]; then
    ###initramfs_entry_add "kernel/drivers/virtio/virtio_pci.ko*"
    :
  else
    initramfs_entry_add "kernel/drivers/block/virtio_blk.ko*"
  fi
  initramfs_entry_add "kernel/drivers/char/hw_random/rng-core.ko*"
  initramfs_entry_add "kernel/drivers/char/hw_random/virtio-rng.ko*"
  initramfs_entry_add "kernel/drivers/char/virtio_console.ko*"
  initramfs_entry_add "kernel/drivers/crypto/virtio"
  case $image_os_device_type in
    nvme )
      initramfs_entry_add "kernel/drivers/nvme/host/nvme.ko*"
      ;;
    sata | scsi )
      initramfs_entry_add "kernel/drivers/scsi/sd_mod.ko*"
      initramfs_entry_add "kernel/drivers/scsi/virtio_scsi.ko*"
      ;;
  esac
  initramfs_entry_add "kernel/drivers/virtio"
  initramfs_entry_finish

  if [ -n "${debug_enabled+x}" ]; then
    cat <<'EOF' >> "$run_script"

    # Debug
    {
      write_debug_log "vm-virtio.modules contents:" 2
      cat /etc/mkinitfs/features.d/vm-virtio.modules >> /chroot.log
    }
EOF
  fi

  cat <<'EOF' >> "$run_script"
  }
EOF
}


#
# Create VM Virtualbox mkinitfs feature file
#
configure_mkinitfs_feature_vm_virtualbox() {
  cat <<'EOF' >> "$run_script"

  {
    write_log "Setting up features.d/vm-virtualbox.modules" 2
EOF

  initramfs_entry_initialise "vm-virtualbox"
  initramfs_entry_add "kernel/drivers/acpi/tiny-power-button.ko*"
  if [ -n "${image_optimise+x}" ]; then
    initramfs_entry_add "kernel/drivers/gpu/drm/vmwgfx/vmwgfx.ko*"
    initramfs_entry_add "kernel/drivers/virt/vboxguest/vboxguest.ko*"
    initramfs_entry_add "kernel/drivers/virtio/virtio.ko*"
    initramfs_entry_add "kernel/drivers/virtio/virtio_pci.ko*"
    initramfs_entry_add "kernel/drivers/virtio/virtio_ring.ko*"
  else
    initramfs_entry_add "kernel/drivers/gpu/drm/vmwgfx"
    initramfs_entry_add "kernel/drivers/virt/vboxguest"
    initramfs_entry_add "kernel/drivers/virtio"
  fi
  initramfs_entry_add "kernel/drivers/net/virtio_net.ko*"
  case $image_os_device_type in
    nvme )
      initramfs_entry_add "kernel/drivers/nvme/host/nvme.ko*"
      ;;
    sata | scsi )
      initramfs_entry_add "kernel/drivers/scsi/sd_mod.ko*"
      initramfs_entry_add "kernel/drivers/scsi/virtio_scsi.ko*"
      ;;
  esac
  initramfs_entry_finish

  if [ -n "${debug_enabled+x}" ]; then
    cat <<'EOF' >> "$run_script"

    # Debug
    {
      write_debug_log "vm-virtualbox.modules contents:" 2
      cat /etc/mkinitfs/features.d/vm-virtualbox.modules >> /chroot.log
    }
EOF
  fi

  cat <<'EOF' >> "$run_script"
  }
EOF
}


#
# Create VM VMware mkinitfs feature file
#
configure_mkinitfs_feature_vm_vmware() {
  cat <<'EOF' >> "$run_script"

  {
    write_log "Setting up features.d/vm-vmware.modules" 2
EOF

  initramfs_entry_initialise "vm-vmware"
  initramfs_entry_add "kernel/drivers/acpi/tiny-power-button.ko*"
  if [ -n "${image_optimise+x}" ]; then
    initramfs_entry_add "kernel/drivers/gpu/drm/vmwgfx/vmwgfx.ko*"
  else
    initramfs_entry_add "kernel/drivers/gpu/drm/vmwgfx"
  fi
  initramfs_entry_add "kernel/drivers/scsi/sd_mod.ko*"
  initramfs_entry_add "kernel/drivers/scsi/virtio_scsi.ko*"
  initramfs_entry_add "kernel/drivers/virtio/virtio.ko*"
  initramfs_entry_add "kernel/drivers/virtio/virtio_pci.ko*"
  initramfs_entry_add "kernel/drivers/virtio/virtio_ring.ko*"
  initramfs_entry_add "kernel/drivers/net/vmxnet3"
  initramfs_entry_finish

  if [ -n "${debug_enabled+x}" ]; then
    cat <<'EOF' >> "$run_script"

    # Debug
    {
      write_debug_log "vm-vmware.modules contents:" 2
      cat /etc/mkinitfs/features.d/vm-vmware.modules >> /chroot.log
    }
EOF
  fi

  cat <<'EOF' >> "$run_script"
  }
EOF
}


#
# Define virtual machine specific packages
#
define_virtual_machine_packages() {
  local _virtual_pkgs=""

  case $image_vm_type in
    hyperv )
      _virtual_pkgs="hvtools" ;;
    libvirtd | lxd | proxmox | qemu )
      _virtual_pkgs="qemu-guest-agent" ;;
    virtualbox )
      _virtual_pkgs="virtualbox-guest-additions" ;;
    vmware )
      _virtual_pkgs="open-vm-tools open-vm-tools-guestinfo"
      _virtual_pkgs="${_virtual_pkgs} open-vm-tools-timesync open-vm-tools-vix"
      ;;
  esac

  echo "$_virtual_pkgs"
}


#
# Define the cloud-init DataSource(s) to enable for the relevant VM type
#
define_virtual_settings() {
  case $image_vm_type in
    hyperv )
      datasource_list="'NoCloud'" ;;
    libvirtd | lxd | proxmox | qemu )
      datasource_list="'NoCloud'"
      if [ "$image_console_type" = "serial" ] && \
         { [ "$image_arch" = "armv7" ] || \
           [ "$image_arch" = "aarch64" ]; }; then
        serial_port_number="0"
        serial_port_name="ttyAMA${serial_port_number}"
      fi
      ;;
    opennebula )
      datasource_list="'Opennebula'" ;;
    openstack )
      datasource_list="'Openstack'" ;;
    rhvm )
      datasource_list="'AltCloud','Openstack'" ;;
    virtualbox )
      datasource_list="'NoCloud'" ;;
    vmware )
      datasource_list="'OVF'" ;;
    vsphere )
      datasource_list="'AltCloud'" ;;
    generic )
      datasource_list="'AltCloud','ConfigDrive','Opennebula','Openstack','NoCloud','OVF'" ;;
  esac
  if [ "$datasource_list" = "'NoCloud'" ] && \
     [ -n "${cloud_seed_url+x}" ]; then
    datasource_settings="$(printf \\t%s\\n "  NoCloud:" "    seedfrom: $cloud_seed_url")"
  fi
}


#
# Add virtual machine related entries to /etc/modules
#
etc_modules_list_for_virtual() {
  cat <<'EOF' >> "$run_script"
	
	# VM-specific modules
	tiny-power-button
EOF

  case $image_vm_type in
    hyperv )
      cat <<'EOF' >> "$run_script"
	hv_utils
EOF
      ;;
    libvirtd | lxd | proxmox | qemu | generic )
      if [ "$image_os_device_type" = "nvme" ]; then
        cat <<'EOF' >> "$run_script"
	nvme
EOF
      fi
      cat <<'EOF' >> "$run_script"
	ptp_kvm
	virtio-rng
EOF
      ;;
    virtualbox )
      if [ "$image_os_device_type" = "nvme" ]; then
        cat <<'EOF' >> "$run_script"
	nvme
EOF
      fi
      ;;
    vmware )
      cat <<'EOF' >> "$run_script"
	ptp_vmw
EOF
      ;;
  esac

  case $image_vm_type in
    hyperv | vmware )
      # Do not add virtio_net module for Hyper-V or VMware
      ;;
    * )
      cat <<'EOF' >> "$run_script"
	virtio_net
EOF
    ;;
  esac
}
